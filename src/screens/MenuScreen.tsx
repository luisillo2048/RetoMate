// screens/MenuScreen.tsx
import React, { useState, useEffect, useRef } from "react";
import {
  View,
  Text,
  TouchableOpacity,
  ScrollView,
  Modal,
  Image,
  Animated,
  Easing,
  Dimensions,
} from "react-native";
import {
  FontAwesome5,
  Ionicons,
  MaterialCommunityIcons,
  Feather,
} from "@expo/vector-icons";
import { useNavigation } from "@react-navigation/native";
import { LinearGradient } from "expo-linear-gradient";
import { useUserLevel } from "../context/UserLevelContext";
import { useTheme } from "../context/ThemeContext";
import { useAuth } from "../context/AuthContext";
import styles from "../themes/MenuStyles";
import ChatBot from "./ChatBot";

const { width, height } = Dimensions.get('window');

const MenuScreen = () => {
  const navigation = useNavigation();
  const { block } = useUserLevel();
  const { theme, toggleTheme, colors } = useTheme();
  const { logout } = useAuth();

  const [isDrawerVisible, setDrawerVisible] = useState(false);
  const [chatVisible, setChatVisible] = useState(false);
  const [isLoggingOut, setIsLoggingOut] = useState(false);
  
  // Referencia para el ScrollView
  const scrollViewRef = useRef(null);
  
  // Animaciones
  const bounceAnim = useState(new Animated.Value(0))[0];
  const pulseAnim = useState(new Animated.Value(1))[0];
  const slideAnim = useState(new Animated.Value(50))[0];
  const fadeAnim = useState(new Animated.Value(0))[0];
  const drawerSlideAnim = useState(new Animated.Value(-300))[0];
  
  // Nueva animaci√≥n para el movimiento del chatbot con el scroll
  const chatBotTranslateY = useRef(new Animated.Value(0)).current;
  const scrollY = useRef(new Animated.Value(0)).current;

  useEffect(() => {
    // Animaci√≥n de entrada
    Animated.parallel([
      Animated.spring(bounceAnim, {
        toValue: 1,
        friction: 8,
        tension: 40,
        useNativeDriver: true,
      }),
      Animated.timing(slideAnim, {
        toValue: 0,
        duration: 600,
        easing: Easing.out(Easing.cubic),
        useNativeDriver: true,
      }),
      Animated.timing(fadeAnim, {
        toValue: 1,
        duration: 800,
        useNativeDriver: true,
      })
    ]).start();

    // Animaci√≥n de pulso continua para el chatbot
    Animated.loop(
      Animated.sequence([
        Animated.timing(pulseAnim, {
          toValue: 1.1,
          duration: 1000,
          easing: Easing.inOut(Easing.ease),
          useNativeDriver: true,
        }),
        Animated.timing(pulseAnim, {
          toValue: 1,
          duration: 1000,
          easing: Easing.inOut(Easing.ease),
          useNativeDriver: true,
        }),
      ])
    ).start();

    // Configurar el listener para el scroll
    const scrollListener = scrollY.addListener(({ value }) => {
      // El chatbot se mover√° en la direcci√≥n opuesta al scroll para dar efecto de parallax
      chatBotTranslateY.setValue(-value * 0.3); // 0.3 es la velocidad del parallax
    });

    return () => {
      scrollY.removeListener(scrollListener);
    };
  }, []);

  // Abrir drawer con animaci√≥n
  const openDrawer = () => {
    setDrawerVisible(true);
    Animated.timing(drawerSlideAnim, {
      toValue: 0,
      duration: 300,
      easing: Easing.out(Easing.cubic),
      useNativeDriver: true,
    }).start();
  };

  // Cerrar drawer con animaci√≥n
  const closeDrawer = () => {
    Animated.timing(drawerSlideAnim, {
      toValue: -300,
      duration: 300,
      easing: Easing.in(Easing.cubic),
      useNativeDriver: true,
    }).start(() => {
      setDrawerVisible(false);
    });
  };

  // Manejar logout de manera segura
  const handleLogout = async () => {
    if (isLoggingOut) return;
    
    setIsLoggingOut(true);
    try {
      // Primero cerramos el drawer
      closeDrawer();
      
      // Esperamos un poco para que la animaci√≥n del drawer termine
      setTimeout(async () => {
        await logout();
        // Usamos navigate en lugar de reset para evitar problemas
        navigation.navigate("Login" as never);
      }, 350);
    } catch (error) {
      console.error('Error durante logout:', error);
      setIsLoggingOut(false);
    }
  };

  // Funci√≥n simple de audio placeholder
  const playAudio = (audioType: string) => {
    console.log(`Reproduciendo audio: ${audioType}`);
    // Aqu√≠ puedes agregar la funcionalidad de audio m√°s tarde
    // Por ahora solo es un placeholder
  };

  // Contenido educativo para el men√∫ principal
  const educationalContent = [
    {
      title: "¬°Aprende Jugando! üé≤",
      description: "Descubre c√≥mo los n√∫meros pueden ser divertidos. Aprender√°s a contar, sumar y restar mientras te diviertes.",
      icon: "üéØ",
      color: [colors.primary, colors.secondary],
      audioType: "learn"
    },
    {
      title: "Tu Amigo Digital ü§ñ",
      description: "Nuestro chatbot te ayudar√° en todo momento. Puedes preguntarle sobre matem√°ticas o pedirle ayuda cuando te sientas atascado.",
      icon: "ü§ñ",
      color: [colors.secondary, colors.primary],
      audioType: "chatbot"
    },
    {
      title: "Gana Premios üèÜ",
      description: "Cada vez que aprendas algo nuevo, ganar√°s estrellas y medallas. ¬°Colecciona todas!",
      icon: "‚≠ê",
      color: [colors.accent, colors.primary],
      audioType: "achievements"
    },
    {
      title: "A Tu Propio Ritmo üê¢",
      description: "No hay prisa. Aprende cuando quieras y vuelve a las lecciones las veces que necesites.",
      icon: "üìö",
      color: [colors.secondary, colors.accent],
      audioType: "pace"
    }
  ];

  // Funci√≥n para manejar el scroll
  const handleScroll = Animated.event(
    [{ nativeEvent: { contentOffset: { y: scrollY } } }],
    { useNativeDriver: true }
  );

  return (
    <LinearGradient 
      colors={colors.background}
      style={styles.container}
    >
      <View style={{ flex: 1 }}>
        {/* Drawer */}
        <Modal 
          visible={isDrawerVisible} 
          animationType="none" 
          transparent
          statusBarTranslucent
          onRequestClose={closeDrawer}
        >
          <View style={styles.modalOverlay}>
            <TouchableOpacity
              style={styles.overlayTouchable}
              activeOpacity={1}
              onPress={closeDrawer}
            />
            <Animated.View 
              style={[
                styles.drawerContainer,
                {
                  transform: [{ translateX: drawerSlideAnim }]
                }
              ]}
            >
              <LinearGradient
                colors={[colors.primary, colors.secondary]}
                style={styles.drawerGradient}
              >
                <View style={styles.drawerHeader}>
                  <Text style={styles.drawerTitle}>Configuraci√≥n</Text>
                  <TouchableOpacity onPress={closeDrawer} style={styles.closeButton}>
                    <Feather name="x" size={24} color="#FFF" />
                  </TouchableOpacity>
                </View>
                
                <View style={styles.drawerContent}>
                  {/* Opci√≥n de Tema */}
                  <TouchableOpacity
                    onPress={toggleTheme}
                    style={styles.drawerItem}
                    disabled={isLoggingOut}
                  >
                    <View style={styles.drawerIconContainer}>
                      <Feather
                        name={theme === "light" ? "moon" : "sun"}
                        size={24}
                        color="#FFF"
                      />
                    </View>
                    <View style={styles.drawerTextContainer}>
                      <Text style={styles.drawerText}>
                        {theme === "light" ? "Modo Oscuro" : "Modo Claro"}
                      </Text>
                      <Text style={styles.drawerSubtext}>
                        {theme === "light" ? "Activar modo noche" : "Activar modo d√≠a"}
                      </Text>
                    </View>
                  </TouchableOpacity>

                  {/* Separador */}
                  <View style={styles.drawerSeparator} />

                  {/* Opci√≥n de Cerrar Sesi√≥n */}
                  <TouchableOpacity
                    onPress={handleLogout}
                    style={styles.drawerItem}
                    disabled={isLoggingOut}
                  >
                    <View style={styles.drawerIconContainer}>
                      <Feather 
                        name="log-out" 
                        size={24} 
                        color={isLoggingOut ? "rgba(255,255,255,0.5)" : "#FFF"} 
                      />
                    </View>
                    <View style={styles.drawerTextContainer}>
                      <Text style={[
                        styles.drawerText,
                        isLoggingOut && { color: "rgba(255,255,255,0.5)" }
                      ]}>
                        {isLoggingOut ? "Cerrando sesi√≥n..." : "Cerrar Sesi√≥n"}
                      </Text>
                      <Text style={[
                        styles.drawerSubtext,
                        isLoggingOut && { color: "rgba(255,255,255,0.5)" }
                      ]}>
                        Salir de la aplicaci√≥n
                      </Text>
                    </View>
                  </TouchableOpacity>
                </View>

                <View style={styles.drawerFooter}>
                  <Text style={styles.footerText}>Versi√≥n 1.0</Text>
                  <Text style={styles.footerText}>¬°Aprende Divirti√©ndote! üéâ</Text>
                </View>
              </LinearGradient>
            </Animated.View>
          </View>
        </Modal>

        {/* Scroll Menu con espacio para el navbar */}
        <Animated.ScrollView 
          ref={scrollViewRef}
          style={styles.scrollContainer} 
          showsVerticalScrollIndicator={false}
          contentContainerStyle={styles.scrollContent}
          onScroll={handleScroll}
          scrollEventThrottle={16}
        >
          {/* Header Animado */}
          <Animated.View 
            style={[
              styles.header,
              {
                opacity: fadeAnim,
                transform: [
                  { scale: bounceAnim },
                  { translateY: slideAnim }
                ]
              }
            ]}
          >
            <TouchableOpacity
              onPress={openDrawer}
              style={styles.menuButton}
            >
              <Feather
                name="menu"
                size={28}
                color="#FFF"
              />
            </TouchableOpacity>
            <View style={styles.titleContainer}>
              <Text style={styles.welcomeTitle}>¬°Hola, Amiguito! üëã</Text>
              <Text style={styles.subtitle}>Bienvenido a tu aventura de aprendizaje</Text>
            </View>
          </Animated.View>

          {/* Contenido Educativo Animado */}
          <View style={styles.contentContainer}>
            <Animated.View
              style={[
                styles.welcomeCard,
                {
                  opacity: fadeAnim,
                  transform: [
                    { 
                      translateY: fadeAnim.interpolate({
                        inputRange: [0, 1],
                        outputRange: [30, 0]
                      })
                    }
                  ]
                }
              ]}
            >
              <LinearGradient
                colors={[colors.primary, colors.secondary]}
                style={styles.welcomeCardGradient}
              >
                <View style={styles.welcomeHeader}>
                  <Text style={styles.welcomeCardTitle}>¬°Comienza tu Aventura! üöÄ</Text>
                </View>
                <Text style={styles.welcomeCardText}>
                  Aqu√≠ aprender√°s matem√°ticas de una manera super divertida. 
                  N√∫meros, sumas, restas y mucho m√°s te esperan.
                </Text>
                <View style={styles.welcomeEmojis}>
                  <Text style={styles.emojiLarge}>üî¢</Text>
                  <Text style={styles.emojiLarge}>‚ûï</Text>
                  <Text style={styles.emojiLarge}>‚ûñ</Text>
                  <Text style={styles.emojiLarge}>üéØ</Text>
                </View>
              </LinearGradient>
            </Animated.View>

            {/* Tarjetas de Descripci√≥n */}
            {educationalContent.map((item, index) => (
              <Animated.View
                key={index}
                style={[
                  styles.descriptionCard,
                  {
                    opacity: fadeAnim,
                    transform: [
                      { 
                        translateY: fadeAnim.interpolate({
                          inputRange: [0, 1],
                          outputRange: [50, 0]
                        })
                      }
                    ]
                  }
                ]}
              >
                <TouchableOpacity
                  style={styles.descriptionTouchable}
                  activeOpacity={0.9}
                >
                  <LinearGradient
                    colors={item.color}
                    style={styles.descriptionGradient}
                    start={{ x: 0, y: 0 }}
                    end={{ x: 1, y: 1 }}
                  >
                    <View style={styles.descriptionHeader}>
                      <Text style={styles.descriptionIcon}>{item.icon}</Text>
                      <Text style={styles.descriptionTitle}>{item.title}</Text>
                    </View>
                    <Text style={styles.descriptionText}>{item.description}</Text>
                  </LinearGradient>
                </TouchableOpacity>
              </Animated.View>
            ))}

            {/* Secci√≥n del Chatbot */}
            <Animated.View
              style={[
                styles.chatbotSection,
                {
                  opacity: fadeAnim,
                  transform: [
                    { 
                      translateY: fadeAnim.interpolate({
                        inputRange: [0, 1],
                        outputRange: [50, 0]
                      })
                    }
                  ]
                }
              ]}
            >
              <LinearGradient
                colors={[colors.accent, colors.primary]}
                style={styles.chatbotGradient}
              >
                <View style={styles.chatbotContent}>
                  <View style={styles.chatbotTextContainer}>
                    <Text style={styles.chatbotTitle}>Tu Ayudante M√°gico üßô‚Äç‚ôÇÔ∏è</Text>
                    <Text style={styles.chatbotDescription}>
                      Presiona el bot√≥n flotante para hablar con nuestro chatbot. 
                      √âl te explicar√° ejercicios, responder√° tus preguntas y te 
                      animar√° cuando lo necesites. ¬°Es como tener un profesor 
                      siempre contigo!
                    </Text>
                  </View>
                  <View style={styles.chatbotIconContainer}>
                    <Text style={styles.chatbotEmoji}>ü§ñ</Text>
                  </View>
                </View>
              </LinearGradient>
            </Animated.View>

            {/* Barra de espacio para el navbar */}
            <View style={styles.navbarSpacer} />
          </View>
        </Animated.ScrollView>

        {/* Bot√≥n del Chatbot que se mueve con el scroll - POSICI√ìN CORREGIDA */}
        <Animated.View
          style={[
            styles.chatBotButton,
            {
              transform: [
                { scale: pulseAnim },
                { 
                  translateY: Animated.add(
                    bounceAnim.interpolate({
                      inputRange: [0, 1],
                      outputRange: [100, 0]
                    }),
                    chatBotTranslateY
                  )
                }
              ]
            }
          ]}
        >
          <TouchableOpacity
            onPress={() => setChatVisible(true)}
            style={styles.chatButton}
          >
            <LinearGradient
              colors={[colors.accent, colors.primary]}
              style={styles.chatButtonGradient}
            >
              <Image
                source={require("../../assets/images/chatbot.png")}
                style={styles.chatBotImage}
              />
              <View style={styles.notificationDot} />
            </LinearGradient>
          </TouchableOpacity>
          
          {/* Burbuja de mensaje */}
          <Animated.View 
            style={[
              styles.chatBubble,
              {
                opacity: pulseAnim.interpolate({
                  inputRange: [1, 1.1],
                  outputRange: [0.8, 1]
                })
              }
            ]}
          >
            <Text style={styles.chatBubbleText}>¬°T√≥came! üëã</Text>
          </Animated.View>
        </Animated.View>

        {/* ChatBot */}
        <ChatBot visible={chatVisible} onClose={() => setChatVisible(false)} />
      </View>
    </LinearGradient>
  );
};

export default MenuScreen;